# Mini Ledger Service

Ledger service для управления балансами мерчантов и переводами между ними с поддержкой множественных валют, идемпотентности и комиссий.

## Технологии

- Python 3.10+
- FastAPI
- SQLAlchemy (async)
- PostgreSQL
- pytest

## Установка и запуск

```bash
# Установка зависимостей
pip install -r requirements.txt

# Настройка базы данных в config.py
# Затем инициализация таблиц
python scripts/init_database.py

# Запуск сервера
python main.py
```

API доступен на `http://localhost:8000`, документация - `http://localhost:8000/docs`

## Примеры API запросов

### Создать мерчанта
```bash
curl -X POST http://localhost:8000/api/v1/merchants \
  -H "Content-Type: application/json" \
  -d '{
    "merchant_name": "alice_store",
    "currency": "BTC",
    "initial_balance": "0.00001"
  }'
```

### Получить баланс
```bash
curl http://localhost:8000/api/v1/merchants/alice_store/balance?currency=BTC
```

### Выполнить перевод
```bash
curl -X POST http://localhost:8000/api/v1/transfers \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: unique-key-123" \
  -d '{
    "from_merchant": "alice_store",
    "to_merchant": "bob_shop",
    "currency": "BTC",
    "amount": "0.000005"
  }'
```

### Список переводов
```bash
curl "http://localhost:8000/api/v1/transfers?from=alice_store&currency=BTC"
```

## Архитектура

Проект использует Clean Architecture с разделением на слои:

- **domain/** - бизнес-логика, сущности (Merchant, Balance, Transfer)
- **application/** - use cases, интерфейсы репозиториев
- **infrastructure/** - реализация репозиториев, модели БД
- **api/** - HTTP endpoints, схемы валидации

## Идемпотентность

Каждый перевод требует заголовок `Idempotency-Key` с уникальным значением.

При первом запросе:
- Ключ сохраняется в БД вместе с результатом перевода
- Выполняется перевод и обновляются балансы

При повторном запросе с тем же ключом:
- Система находит сохраненный результат
- Возвращает тот же `transfer_id` и данные
- Перевод не выполняется повторно, балансы не меняются
- В ответе `is_duplicate: true`

Комиссия рассчитывается один раз при первом запросе и сохраняется вместе с ключом.

## Конкурентность

Для предотвращения отрицательных балансов используется блокировка строк на уровне БД (`SELECT ... FOR UPDATE`).

При обновлении баланса:
1. Блокируется строка баланса
2. Проверяется достаточность средств (сумма + комиссия)
3. Обновление выполняется атомарно
4. Блокировка снимается при коммите транзакции

Проверка `balance >= (amount + fee)` выполняется атомарно в одной транзакции.

## Мультивалютность

- Поддерживаются любые коды валют (BTC, ETH, USD и т.д.)
- У каждого мерчанта может быть несколько балансов в разных валютах
- Переводы указывают конкретную валюту
- Балансы по разным валютам независимы

## Комиссии

Комиссия рассчитывается как процент от суммы перевода (по умолчанию 0.1%).

Формула: `fee = (amount * fee_percent) / 100`

Пример: сумма 1.0 BTC, комиссия 0.1% = 0.001 BTC. С отправителя списывается 1.001 BTC.

Комиссия:
- Рассчитывается при создании перевода
- Списывается вместе с суммой перевода
- Сохраняется в записи перевода
- При идемпотентности возвращается та же комиссия

Настройка в `config.py`: `transfer_fee_percent = 0.1`

## Потенциальные улучшения

- Кэширование ключей идемпотентности в Redis
- Батч-переводы (несколько переводов в одном запросе)
- Лимиты на переводы для мерчантов
- Аудит-лог всех операций
- Webhooks для уведомлений
- Аутентификация и авторизация
- Метрики и мониторинг
- Конвертация валют
